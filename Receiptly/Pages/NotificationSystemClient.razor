@page "/NotificationSystemClient"
@using Receiptly.Interface
@using Receiptly.Service
@inject INotificationService NotificationService
@inject HttpClient Http

<h3>Notifications</h3>

<ul>
    @foreach (var notification in Notifications)
    {
        <li>@notification</li>
    }
</ul>

<button @onclick="StartPolling" disabled="@IsPolling">Start Polling</button>
<button @onclick="StopPolling" disabled="!IsPolling">Stop Polling</button>

<p>@StatusMessage</p>

@code {
    private List<string> Notifications { get; set; } = new List<string>();
    private bool IsPolling { get; set; } = false;
    private CancellationTokenSource? CancellationTokenSource { get; set; }
    private string StatusMessage { get; set; } = "Idle";

    private async Task StartPolling()
    {
        if (IsPolling)
            return;

        IsPolling = true;
        StatusMessage = "Polling notifications...";
        CancellationTokenSource = new CancellationTokenSource();

        try
        {
            while (!CancellationTokenSource.Token.IsCancellationRequested)
            {
                var response = await Http.GetAsync("api/notifications", CancellationTokenSource.Token);

                if (response.IsSuccessStatusCode)
                {
                    var base64Message = await response.Content.ReadAsStringAsync(CancellationTokenSource.Token);
                    var decodedMessage = System.Text.Encoding.UTF8.GetString(
                        Convert.FromBase64String(base64Message));
                    Notifications.Add(decodedMessage);
                    
                    await NotificationService.NotifyAsync(decodedMessage);
                }
                else if (response.StatusCode == System.Net.HttpStatusCode.NoContent)
                {
                    StatusMessage = "No new notifications.";
                }
                
                await Task.Delay(5000, CancellationTokenSource.Token);
            }
        }
        catch (OperationCanceledException)
        {
            StatusMessage = "Polling stopped.";
        }
        finally
        {
            IsPolling = false;
        }
    }

    private void StopPolling()
    {
        CancellationTokenSource?.Cancel();
        StatusMessage = "Polling stopped.";
    }

    protected override void OnInitialized()
    {
        StatusMessage = "Ready to start polling.";
    }

}