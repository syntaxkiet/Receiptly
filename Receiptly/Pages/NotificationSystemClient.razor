@page "/NotificationSystemClient"
@using Receiptly.Interface
@using Receiptly.Service
@inject INotificationService NotificationService
@inject HttpClient Http

<h3>Notifications</h3>

<ul>
    @foreach (var notification in Notifications)
    {
        <li>@notification</li>
    }
</ul>

<button @onclick="StartPolling" disabled="@IsPolling">Start Polling</button>
<button @onclick="StopPolling" disabled="!IsPolling">Stop Polling</button>

<p>@StatusMessage</p>

@code {
    private List<string> Notifications { get; set; } = new List<string>();
    private bool IsPolling { get; set; } = false;
    private CancellationTokenSource? CancellationTokenSource { get; set; }
    private string StatusMessage { get; set; } = "Idle";

    private async Task StartPolling()
    {
        if (IsPolling) return;

        IsPolling = true;
        CancellationTokenSource = new CancellationTokenSource();
        Console.WriteLine("Polling started.");
        StatusMessage = "Polling notifications...";

        try
        {
            while (!CancellationTokenSource.Token.IsCancellationRequested)
            {
                var response = await Http.GetAsync("api/notifications", CancellationTokenSource.Token);
                Console.WriteLine($"Response StatusCode: {response.StatusCode}");

                if (response.StatusCode == System.Net.HttpStatusCode.OK)
                {
                    var base64Message = await response.Content.ReadAsStringAsync(CancellationTokenSource.Token);
                    var decodedMessage = System.Text.Encoding.UTF8.GetString(Convert.FromBase64String(base64Message));

                    Notifications.Add(decodedMessage);
                    await NotificationService.NotifyAsync(decodedMessage);
                    Console.WriteLine("Received notifications.");
                    StatusMessage = "Notification received.";
                }
                else if (response.StatusCode == System.Net.HttpStatusCode.NoContent)
                {
                    Console.WriteLine("No new notifications.");
                    StatusMessage = "No new notifications.";
                }
                else
                {
                    Console.WriteLine($"Unexpected status code: {response.StatusCode}");
                    StatusMessage = $"Error: {response.StatusCode}";
                    break; 
                }
                
                await Task.Delay(5000, CancellationTokenSource.Token);
            }
        }
        catch (OperationCanceledException)
        {
            Console.WriteLine("Client ready to poll.");
            StatusMessage = "Polling stopped.";
        }
        catch (Exception ex)
        {
            StatusMessage = $"Error: {ex.Message}";
        }
        finally
        {
            //TODO: Resolve application flow to exit polling state
            Console.WriteLine("Polling stopped, state change initiated.");
            IsPolling = false;
            StateHasChanged(); 
        }
    }

    private void StopPolling()
    {
        CancellationTokenSource?.Cancel();
        Console.WriteLine("Stopped the polling.");
        StatusMessage = "Polling stopped.";
    }

    protected override void OnInitialized()
    {
        Console.WriteLine("Client ready to poll.");
        StatusMessage = "Ready to start polling.";
    }

}